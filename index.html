<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSM Torre de Controle - Dashboard de Vendas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        :root { 
            --dsm-blue: #1f4788; --dsm-green: #4caf50; --bg-primary: #0f1419; --bg-secondary: #1a202c; --bg-card: #2d3748; --bg-card-hover: #374151; --border-color: #4a5568; --text-primary: #ffffff; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --accent-blue: #3b82f6; --accent-teal: #14b8a6; --accent-orange: #f59e0b; --accent-green: #10b981; --accent-red: #ef4444; --gradient-dsm: linear-gradient(135deg, var(--dsm-blue) 0%, var(--dsm-green) 100%); --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2); 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; line-height: 1.6; font-size: 14px; overflow-x: auto; }
        .dashboard { padding: 24px; max-width: 1920px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr 1fr 1fr; grid-template-rows: auto auto 1fr; gap: 24px; min-height: 100vh; grid-template-areas: "header header header header" "sidebar kpi1 kpi2 kpi3" "sidebar chart1 chart1 chart2"; }
        .header { grid-area: header; background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border-radius: 16px; padding: 24px 32px; border: 2px solid var(--border-color); position: relative; overflow: hidden; box-shadow: var(--shadow-lg); }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--gradient-dsm); }
        .header-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
        .header-left { display: flex; align-items: center; gap: 24px; }
        .dsm-logo img { height: 45px; width: auto; background-color: rgba(255,255,255,0.1); border-radius: 8px; }
        .header-info h1 { font-size: 28px; font-weight: 700; margin: 0; background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-stats { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .period-badge { background: var(--gradient-dsm); padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
        .filters { display: flex; gap: 12px; background: var(--bg-secondary); padding: 8px; border-radius: 12px; border: 1px solid var(--border-color); flex-wrap: wrap; }
        .filter-btn { padding: 12px 20px; background: transparent; border: none; color: var(--text-secondary); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .filter-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .filter-btn.active { background: var(--gradient-dsm); color: white; box-shadow: 0 4px 12px rgba(31, 71, 136, 0.3); }
        .date-filter-container { display: flex; gap: 8px; background: var(--bg-secondary); padding: 8px; border-radius: 12px; border: 1px solid var(--border-color); align-items: center; flex-wrap: wrap; }
        .date-input { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px 12px; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 500; outline: none; transition: all 0.3s ease; min-width: 130px; color-scheme: dark; }
        .date-input::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }
        .date-input:focus { border-color: var(--dsm-blue); box-shadow: 0 0 0 2px rgba(31, 71, 136, 0.3); }
        .date-separator { color: var(--text-muted); font-weight: 600; font-size: 13px; }
        .apply-date-btn { background: var(--gradient-dsm); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .apply-date-btn:hover { box-shadow: 0 4px 12px rgba(31, 71, 136, 0.3); }
        .clear-date-btn { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .clear-date-btn:hover { color: var(--text-primary); border-color: var(--text-secondary); }
        .card { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); border-radius: 16px; border: 1px solid var(--border-color); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-8px); border-color: var(--dsm-blue); box-shadow: 0 20px 40px rgba(31, 71, 136, 0.2); }
        .card-header { padding: 24px 24px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
        .card-title { font-size: 13px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .card-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .kpi-card { grid-area: kpi1; } #kpi-card-2 { grid-area: kpi2; } #kpi-card-3 { grid-area: kpi3; }
        .kpi-content { padding: 32px 24px; text-align: center; position: relative; z-index: 2; }
        .kpi-value { font-size: 36px; font-weight: 900; margin-bottom: 12px; background: var(--gradient-teal); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: 'Inter', monospace; letter-spacing: -1px; }
        .kpi-value.orange { background: var(--gradient-orange); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .kpi-value.blue { background: var(--gradient-blue); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .kpi-subtitle { font-size: 13px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .sidebar-card { grid-area: sidebar; padding: 0; }
        .vendor-list { padding: 24px; }
        .vendor-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .vendor-item:hover { background: var(--bg-card-hover); transform: translateX(4px); }
        .vendor-info { display: flex; align-items: center; min-width: 0; }
        .vendor-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .vendor-value { font-weight: 700; font-size: 15px; color: var(--accent-teal); flex-shrink: 0; margin-left: 16px; }
        .vendor-rank { width: 28px; height: 28px; background: var(--gradient-dsm); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: white; margin-right: 12px; flex-shrink: 0; }
        .performance-ratio { margin: 0 24px 24px 24px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); }
        .ratio-item { display: flex; justify-content: space-between; }
        .ratio-item span:first-child { font-size: 13px; color: var(--text-secondary); }
        .ratio-item span:last-child { font-size: 13px; font-weight: 600; }
        .large-card { padding: 0; } #chart-card-1 { grid-area: chart1; } #chart-card-2 { grid-area: chart2; }
        .chart-container { padding: 24px; height: 400px; position: relative; z-index: 2; }
        .admin-container { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 24px;}
        .upload-area, .login-area, .config-area { padding: 48px; border: 3px dashed var(--border-color); border-radius: 16px; text-align: center; transition: all 0.4s ease; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%); }
        .login-area { grid-column: 1 / -1; }
        .upload-area.hidden, .login-area.hidden, .config-area.hidden { display: none; }
        .upload-area:hover, .login-area:hover, .config-area:hover { border-color: var(--dsm-blue); transform: translateY(-4px); box-shadow: 0 12px 24px rgba(31, 71, 136, 0.15); }
        .upload-area.active { border-color: var(--dsm-green); box-shadow: 0 0 32px rgba(76, 175, 80, 0.2); }
        .upload-icon { font-size: 56px; margin-bottom: 24px; color: var(--dsm-blue); display: block; }
        .upload-text, .login-text, .config-text { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .upload-subtext { font-size: 14px; color: var(--text-muted); }
        .upload-highlight { color: var(--dsm-blue); font-weight: 700; }
        .publish-container { text-align: center; margin-top: 24px; }
        .publish-btn, .config-btn { background: var(--gradient-dsm); color: white; font-size: 16px; font-weight: 700; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; }
        .publish-btn:hover, .config-btn:hover { transform: scale(1.05); box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3); }
        .publish-btn:disabled { background: var(--border-color); cursor: not-allowed; }
        .status-message { margin-top: 16px; font-size: 14px; font-weight: 500; height: 20px; }
        .status-message.success { color: var(--accent-green); }
        .status-message.error { color: var(--accent-red); }
        .login-form { display: flex; flex-direction: column; gap: 16px; max-width: 400px; margin: 24px auto 0; }
        .login-input, .config-input { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px; border-radius: 8px; font-size: 14px; width:100%; }
        .login-btn { background: var(--accent-blue); color: white; font-size: 16px; font-weight: 600; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
        .config-form { display: flex; flex-direction: column; gap: 16px; max-width: 400px; margin: 24px auto 0; }
        .logo-preview-container { margin-top:24px; padding:16px; background:var(--bg-secondary); border-radius:12px; }
        .logo-preview { max-height: 60px; width: auto; background-color: rgba(255,255,255,0.1); border-radius: 8px; }

        @media (max-width: 1600px) { .header-stats { gap: 12px; } }
        @media (max-width: 1200px) { .dashboard { grid-template-columns: 1fr 1fr; grid-template-areas: "header header" "kpi1 kpi2" "kpi3 sidebar" "chart1 chart1" "chart2 chart2"; } .header-content { flex-direction: column; gap: 24px; } .admin-container { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; grid-template-areas: "header" "kpi1" "kpi2" "kpi3" "sidebar" "chart1" "chart2"; padding: 16px; gap: 16px; } .header-left { flex-direction: column; text-align: center; } .header-stats { width: 100%; justify-content: center; } .filters, .date-filter-container { justify-content: center; width: 100%; } }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="dsm-logo">
                        <img id="dashboard-logo" src="" alt="Logo DSM">
                    </div>
                    <div class="header-info">
                        <h1 id="dashboard-title"></h1>
                    </div>
                </div>
                <div class="header-stats">
                    <div id="period-badge" class="period-badge">Sem Dados</div>
                    <div class="filters" style="display: none;">
                        <button class="filter-btn active" data-filter="all">Tudo</button>
                        <button class="filter-btn" data-filter="30">30d</button>
                        <button class="filter-btn" data-filter="7">7d</button>
                        <button class="filter-btn" data-filter="1">Hoje</button>
                    </div>
                    <div class="date-filter-container" style="display: none;">
                        <input type="date" id="start-date" class="date-input" title="Data inicial">
                        <span class="date-separator">até</span>
                        <input type="date" id="end-date" class="date-input" title="Data final">
                        <button class="apply-date-btn" id="apply-date-btn" title="Aplicar filtro de data">Aplicar</button>
                        <button class="clear-date-btn" id="clear-date-btn" title="Limpar filtro de data">Limpar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="login-area hidden" id="login-area">
            <div class="login-text">Acesso Administrador</div>
            <form class="login-form" id="login-form">
                <input type="email" id="login-email" class="login-input" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" class="login-input" placeholder="Sua senha" required>
                <button type="submit" class="login-btn">Entrar</button>
            </form>
            <div class="status-message" id="login-status-message"></div>
        </div>

        <div class="admin-container">
            <div class="config-area hidden" id="config-area">
                <div class="config-text">Configurações do Dashboard</div>
                <form class="config-form" id="config-form">
                    <input type="text" id="config-title-input" class="config-input" placeholder="Título do Dashboard">
                    <button type="button" class="config-btn" id="save-title-btn">Salvar Título</button>
                    
                    <label for="logo-file" class="upload-highlight" style="cursor:pointer; margin-top:20px;">Clique para carregar uma nova LOGO</label>
                    <input type="file" id="logo-file" accept="image/*" style="display:none;">
                    
                    <div class="logo-preview-container">
                        <p style="color:var(--text-muted); font-size:12px; text-transform:uppercase;">Preview da Logo Atual</p>
                        <img id="logo-preview" src="" alt="Preview da Logo" class="logo-preview">
                    </div>
                </form>
                <div class="status-message" id="config-status-message"></div>
            </div>
            
            <div class="upload-area hidden" id="upload-area">
                <div class="upload-icon">📊</div>
                <div class="upload-text">Carregar Relatório de Vendas</div>
                <div class="upload-subtext">Arraste seu arquivo CSV aqui ou <span class="upload-highlight">clique para selecionar</span></div>
                <input type="file" id="csv-file" accept=".csv" style="display:none;">
                <div class="publish-container" id="publish-container" style="display: none;">
                    <button class="publish-btn" id="publish-btn" disabled>Publicar Dados</button>
                    <div class="status-message" id="status-message"></div>
                </div>
            </div>
        </div>
        
        <div class="card kpi-card" id="kpi-card-1" style="display: none;"></div>
        <div class="card kpi-card" id="kpi-card-2" style="display: none;"></div>
        <div class="card kpi-card" id="kpi-card-3" style="display: none;"></div>
        <div class="card sidebar-card" id="sidebar-card" style="display: none;"></div>
        <div class="card large-card" id="chart-card-1" style="display: none;"></div>
        <div class="card large-card" id="chart-card-2" style="display: none;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDl9TAAJxXCoyBjZa5xJVSx2-9ijq19iAs",
            authDomain: "dash-board-dsm.firebaseapp.com",
            projectId: "dash-board-dsm",
            storageBucket: "dash-board-dsm.appspot.com",
            messagingSenderId: "539970664229",
            appId: "1:539970664229:web:c84df6bcf621d85fab0ccc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let originalData = null;
        let processedDataForPublish = null;
        let customDateFilter = null;
        const DEFAULT_TITLE = "Dashboard Comercial";
        const DEFAULT_LOGO = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACACAYAAAC6yG3+AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAErYSURBVHhe7Z0HgB1FlccrD0NKQiAhEIIg5CJIQBEFFkU2xY6sIAgiIEgREVGQyI4giL4ioiDIvggiiL5LIIsBIiQIeSdNQkICEjLJ7n/X9L1uN7N7s2+2u3v36f18l6pnd2Z6eqp6p6p7qt4kGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhG-Ei0K8eK+7wKkGAAAAAAAAAAAAwA=";

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            setupHighchartsTheme();
            if (isAdmin) {
                auth.onAuthStateChanged(user => {
                    if (user) { initializeAdminView(); } else { initializeLoginView(); }
                });
            } else {
                fetchAndDisplayPublicDashboard();
            }
        });

        function initializeLoginView() { /* ...código original... */ }

        function initializeAdminView() {
            document.getElementById('login-area').classList.add('hidden');
            document.querySelector('.admin-container').style.display = 'grid';
            document.getElementById('config-area').classList.remove('hidden');
            document.getElementById('upload-area').classList.remove('hidden');
            document.querySelector('.header').style.display = 'block';
            document.getElementById('period-badge').textContent = "Modo Administrador";
            
            // Preenche as configurações atuais
            db.collection('dashboard').doc('config').get().then(doc => {
                if (doc.exists) {
                    const config = doc.data();
                    document.getElementById('config-title-input').value = config.title || '';
                    document.getElementById('logo-preview').src = config.logoUrl || DEFAULT_LOGO;
                } else {
                    document.getElementById('config-title-input').value = DEFAULT_TITLE;
                    document.getElementById('logo-preview').src = DEFAULT_LOGO;
                }
            });

            setupUploadArea();
            setupConfigControls();
        }

        async function fetchAndDisplayPublicDashboard() {
            const headerTitle = document.getElementById('dashboard-title');
            const headerLogo = document.getElementById('dashboard-logo');
            const periodBadge = document.getElementById('period-badge');

            try {
                periodBadge.textContent = "Carregando...";
                
                // Busca os dados de config e de vendas em paralelo
                const [configDoc, salesDoc] = await Promise.all([
                    db.collection('dashboard').doc('config').get(),
                    db.collection('dashboard').doc('dados').get()
                ]);

                // Aplica as configurações
                if (configDoc.exists) {
                    const config = configDoc.data();
                    headerTitle.textContent = config.title || DEFAULT_TITLE;
                    headerLogo.src = config.logoUrl || DEFAULT_LOGO;
                } else {
                    headerTitle.textContent = DEFAULT_TITLE;
                    headerLogo.src = DEFAULT_LOGO;
                }

                // Processa os dados de vendas
                if (salesDoc.exists) {
                    const data = salesDoc.data();
                    originalData = data.allRows.map(r => ({ ...r, Data: new Date(r.Data) }));
                    document.querySelectorAll('.kpi-card, .sidebar-card, .large-card').forEach(el => el.style.display = 'block');
                    document.querySelector('.filters').style.display = 'flex';
                    document.querySelector('.date-filter-container').style.display = 'flex';
                    setupFilters();
                    setupDateFilter();
                    document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                    applyFilter('all');
                } else {
                    periodBadge.textContent = "Nenhum dado publicado";
                }
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
                periodBadge.textContent = "Erro ao Carregar";
            }
        }
        
        // --- NOVAS FUNÇÕES DE CONFIGURAÇÃO ---
        function setupConfigControls() {
            document.getElementById('save-title-btn').addEventListener('click', saveTitle);
            document.getElementById('logo-file').addEventListener('change', handleLogoUpload);
        }

        async function saveTitle() {
            const newTitle = document.getElementById('config-title-input').value;
            const statusMsg = document.getElementById('config-status-message');
            if (!newTitle) {
                alert('O título não pode estar vazio.');
                return;
            }
            statusMsg.textContent = 'Salvando título...';
            statusMsg.className = 'status-message';
            try {
                await db.collection('dashboard').doc('config').set({ title: newTitle }, { merge: true });
                statusMsg.textContent = 'Título salvo com sucesso!';
                statusMsg.className = 'status-message success';
                document.getElementById('dashboard-title').textContent = newTitle; // Atualiza o header da pág admin
            } catch (error) {
                statusMsg.textContent = 'Erro ao salvar título.';
                statusMsg.className = 'status-message error';
                console.error("Erro ao salvar título:", error);
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            const statusMsg = document.getElementById('config-status-message');
            if (!file) return;

            statusMsg.textContent = 'Carregando logo...';
            statusMsg.className = 'status-message';

            const reader = new FileReader();
            reader.onload = async function(e) {
                const logoBase64 = e.target.result;
                document.getElementById('logo-preview').src = logoBase64; // Mostra preview
                try {
                    await db.collection('dashboard').doc('config').set({ logoUrl: logoBase64 }, { merge: true });
                    statusMsg.textContent = 'Logo salva com sucesso!';
                    statusMsg.className = 'status-message success';
                    document.getElementById('dashboard-logo').src = logoBase64; // Atualiza o header da pág admin
                } catch (error) {
                    statusMsg.textContent = 'Erro ao salvar a logo.';
                    statusMsg.className = 'status-message error';
                    console.error("Erro ao salvar logo:", error);
                }
            };
            reader.readAsDataURL(file); // Converte imagem para Base64
        }


        // --- FUNÇÕES ANTIGAS (sem alterações, exceto handleFiles e processDataForPublishing para remover diagnóstico) ---

        async function handleAdminLogin(event) { /* ...código original sem alterações... */ }

        function setupUploadArea() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('csv-file');
            document.getElementById('publish-btn').addEventListener('click', publishDataToFirebase);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, p => { p.preventDefault(); p.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.add('active')));
            ['dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.remove('active')));
            uploadArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => handleFiles(e.target.files));
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csvDataAsString = event.target.result;
                    Papa.parse(csvDataAsString, {
                        header: true, skipEmptyLines: true, delimiter: ";",
                        complete: results => processDataForPublishing(results.data),
                        error: error => alert(`ERRO no Papa.parse: ${error.message}`)
                    });
                };
                reader.onerror = function() { alert('ERRO: Não foi possível ler o arquivo: ' + reader.error); };
                reader.readAsText(file, 'UTF-8');
            }
        }

        function processDataForPublishing(data) {
            const statusMessage = document.getElementById('status-message');
            try {
                const allRows = data.map(row => {
                    const valorStr = String(row.Valor || '0').replace('R$', '').trim().replace(/\./g, '').replace(',', '.');
                    const valor = parseFloat(valorStr);
                    if (isNaN(valor) || !row.Data || !row.Vendedor || !row.Cliente) return null;
                    const [day, month, year] = row.Data.split('/');
                    return {
                        Vendedor: row.Vendedor.trim(), Cliente: row.Cliente.trim(),
                        Data: new Date(`${year}-${month}-${day}T00:00:00Z`).toISOString(), Valor: valor
                    };
                }).filter(Boolean);
                processedDataForPublish = { allRows, timestamp: new Date().toISOString() };
                document.getElementById('publish-container').style.display = 'block';
                document.getElementById('publish-btn').disabled = false;
                statusMessage.textContent = `${allRows.length} registros prontos para publicar.`;
                statusMessage.className = 'status-message';
            } catch (error) {
                statusMessage.textContent = `Erro ao processar dados: ${error.message}`;
                statusMessage.className = 'status-message error';
            }
        }

        async function publishDataToFirebase() { /* ...código original sem alterações... */ }
        function setupFilters() { /* ...código original... */ }
        function setupDateFilter() { /* ...código original... */ }
        function applyFilter(days) { /* ...código original... */ }
        function applyCustomDateFilter() { /* ...código original... */ }
        function updateDashboardUI(data) { /* ...código original... */ }
        function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function updateKPIs(data) { /* ...código original... */ }
        function updateSidebar(data) { /* ...código original... */ }
        function renderEvolucaoChart(data) { /* ...código original... */ }
        function renderClientesChart(data) { /* ...código original... */ }
        function setupHighchartsTheme() { /* ...código original... */ }
    </script>
</body>
</html>
