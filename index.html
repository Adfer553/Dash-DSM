<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSM Torre de Controle - Dashboard de Vendas</title>
    <style>
        /* ... (todo o CSS existente permanece igual at√© o final do seu CSS original) ... */
        /* Adicionando estilo para abas */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: center;
        }
        .tab-btn {
            padding: 10px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: var(--gradient-dsm);
            color: white;
            border-color: transparent;
        }
        .tab-content { display: none; }
        .tab-content.active { display: grid; }
    </style>
</head>
<body>
    <!-- Abas de navega√ß√£o -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="vendas">Vendas</button>
        <button class="tab-btn" data-tab="itens">Itens Vendidos</button>
    </div>

    <!-- Aba Vendas (original) -->
    <div class="dashboard tab-content active" id="tab-vendas">
        <!-- Todo o conte√∫do original da sua aba "Vendas" aqui -->
        <!-- (mantido exatamente como est√° no seu arquivo, incluindo header, cards, etc.) -->
        <!-- ... (copie tudo do seu <div class="dashboard"> original at√© o fechamento </div>) ... -->
    </div>

    <!-- Aba Itens (nova) -->
    <div class="dashboard tab-content" id="tab-itens" style="display: none;">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="dsm-logo">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACACAYAAAC6yG3+AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAErYSURBVHhe7Z0HgB1FlccrD0NKQiAhEIIg5CJIQBEFFkU2xY6sIAgiIEgREVGQyI4giL4ioiDIvggiiL5LIIsBIiQIeSdNQkICEjLJ7n/X9L1uN7N7s2+2u3v36f18l6pnd2Z6eqp6p6p7qt4kGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZ...... (mesmo logo base64)" alt="Logo DSM">
                    </div>
                    <div class="header-info">
                        <h1>DSM - Itens Vendidos</h1>
                    </div>
                </div>
                <div class="header-stats">
                    <div id="period-badge-itens" class="period-badge">Sem Dados</div>
                    <div class="filters" style="display: none;">
                        <button class="filter-btn active" data-filter="all">Tudo</button>
                        <button class="filter-btn" data-filter="30">30d</button>
                        <button class="filter-btn" data-filter="7">7d</button>
                        <button class="filter-btn" data-filter="1">Hoje</button>
                    </div>
                    <div class="date-filter-container" style="display: none;">
                        <input type="date" id="start-date-itens" class="date-input" title="Data inicial">
                        <span class="date-separator">at√©</span>
                        <input type="date" id="end-date-itens" class="date-input" title="Data final">
                        <button class="apply-date-btn" id="apply-date-btn-itens" title="Aplicar filtro de data">Aplicar</button>
                        <button class="clear-date-btn" id="clear-date-btn-itens" title="Limpar filtro de data">Limpar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea de login e upload (apenas no modo admin) -->
        <div class="login-area hidden" id="login-area-itens">
            <div class="login-text">Acesso Administrador - Itens</div>
            <form class="login-form" id="login-form-itens">
                <input type="email" class="login-input" placeholder="Seu e-mail" required>
                <input type="password" class="login-input" placeholder="Sua senha" required>
                <button type="submit" class="login-btn">Entrar</button>
            </form>
            <div class="status-message" id="login-status-message-itens"></div>
        </div>
        <div class="upload-area hidden" id="upload-area-itens">
            <div class="upload-icon">üì¶</div>
            <div class="upload-text">Carregar Relat√≥rio de Itens</div>
            <div class="upload-subtext">Arraste seu arquivo CSV aqui ou <span class="upload-highlight">clique para selecionar</span></div>
            <input type="file" id="csv-file-itens" accept=".csv" style="display:none;">
            <div class="publish-container" id="publish-container-itens" style="display: none;">
                <button class="publish-btn" id="publish-btn-itens" disabled>Publicar Dados</button>
                <div class="status-message" id="status-message-itens"></div>
            </div>
        </div>

        <!-- KPIs Itens -->
        <div class="card kpi-card" id="kpi-card-1-itens" style="display: none;">
            <div class="card-header">
                <span class="card-title">Valor Total de Itens</span>
                <div class="card-icon" style="background: var(--gradient-orange);">üì¶</div>
            </div>
            <div class="kpi-content">
                <div class="kpi-value orange" id="kpi-total-itens">R$ 0,00</div>
                <div class="kpi-subtitle">Per√≠odo Selecionado</div>
            </div>
        </div>
        <div class="card kpi-card" id="kpi-card-2-itens" style="display: none;">
            <div class="card-header">
                <span class="card-title">Quantidade Total</span>
                <div class="card-icon" style="background: var(--gradient-teal);">üî¢</div>
            </div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-qtd-itens">0</div>
                <div class="kpi-subtitle">Itens Vendidos</div>
            </div>
        </div>
        <div class="card kpi-card" id="kpi-card-3-itens" style="display: none;">
            <div class="card-header">
                <span class="card-title">Top Produto</span>
                <div class="card-icon" style="background: var(--gradient-blue);">üèÜ</div>
            </div>
            <div class="kpi-content">
                <div class="kpi-value blue" id="kpi-top-produto">‚Äî</div>
                <div class="kpi-subtitle">Mais Vendido</div>
            </div>
        </div>

        <!-- Sidebar: Top Clientes por Itens -->
        <div class="card sidebar-card" id="sidebar-card-itens" style="display: none;">
            <div class="card-header">
                <span class="card-title">Top Clientes (Itens)</span>
                <div class="card-icon" style="background: var(--gradient-dsm);">üë•</div>
            </div>
            <div class="vendor-list" id="vendor-list-itens"></div>
        </div>

        <!-- Gr√°ficos -->
        <div class="card large-card" id="chart-card-1-itens" style="display: none;">
            <div class="card-header">
                <span class="card-title">Top 10 Produtos/Servi√ßos</span>
                <div class="card-icon" style="background: var(--gradient-blue);">üìä</div>
            </div>
            <div class="chart-container" id="chart-produtos"></div>
        </div>
        <div class="card large-card" id="chart-card-2-itens" style="display: none;">
            <div class="card-header">
                <span class="card-title">Top 5 Clientes por Valor</span>
                <div class="card-icon" style="background: var(--gradient-teal);">üí∞</div>
            </div>
            <div class="chart-container" id="chart-clientes-itens"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script>
        // --- CONFIGURA√á√ÉO FIREBASE (mantida) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDl9TAAJxXCoyBjZa5xJVSx2-9ijq19iAs",
            authDomain: "dash-board-dsm.firebaseapp.com",
            projectId: "dash-board-dsm",
            storageBucket: "dash-board-dsm.appspot.com",
            messagingSenderId: "539970664229",
            appId: "1:539970664229:web:c84df6bcf621d85fab0ccc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Dados originais
        let originalDataVendas = null;
        let originalDataItens = null;
        let processedDataForPublishVendas = null;
        let processedDataForPublishItens = null;

        // Estado atual
        let currentTab = 'vendas';

        // --- NAVEGA√á√ÉO ENTRE ABAS ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                currentTab = btn.dataset.tab;
                const targetTab = document.getElementById(`tab-${currentTab}`);
                if (targetTab) targetTab.classList.add('active');

                // Recarregar dados se necess√°rio
                const urlParams = new URLSearchParams(window.location.search);
                const isAdmin = urlParams.get('admin') === 'true';
                if (!isAdmin) {
                    if (currentTab === 'vendas') fetchAndDisplayPublicDashboard('vendas');
                    else fetchAndDisplayPublicDashboard('itens');
                }
            });
        });

        // --- FUN√á√ïES PRINCIPAIS ---
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            setupHighchartsTheme();
            if (isAdmin) {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        if (currentTab === 'vendas') initializeAdminView('vendas');
                        else initializeAdminView('itens');
                    } else {
                        if (currentTab === 'vendas') initializeLoginView('vendas');
                        else initializeLoginView('itens');
                    }
                });
            } else {
                fetchAndDisplayPublicDashboard(currentTab);
            }
        });

        // --- VENDAS: Fun√ß√µes existentes adaptadas com sufixo ou par√¢metro ---
        // (Exemplo: fetchAndDisplayPublicDashboard(tab), initializeAdminView(tab), etc.)

        async function fetchAndDisplayPublicDashboard(tab) {
            const periodBadge = tab === 'vendas' 
                ? document.getElementById('period-badge') 
                : document.getElementById('period-badge-itens');
            try {
                periodBadge.textContent = "Carregando...";
                const doc = await db.collection('dashboard').doc(tab === 'vendas' ? 'dados' : 'itens').get();
                if (doc.exists) {
                    const data = doc.data();
                    if (tab === 'vendas') {
                        originalDataVendas = data.allRows.map(r => ({ ...r, Data: new Date(r.Data) }));
                        showVendasDashboard('all');
                    } else {
                        originalDataItens = data.allRows.map(r => ({ ...r, Data: new Date(r.Data) }));
                        showItensDashboard('all');
                    }
                } else {
                    periodBadge.textContent = "Nenhum dado publicado";
                }
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
                periodBadge.textContent = "Erro ao Carregar";
            }
        }

        // --- ITENS: Fun√ß√µes espec√≠ficas ---
        function showItensDashboard(filterType = 'all') {
            const data = originalDataItens || [];
            const filtered = filterType === 'all' ? data : data; // filtros por data podem ser adicionados depois
            updateItensUI(filtered);
            document.querySelectorAll('#tab-itens .kpi-card, #tab-itens .sidebar-card, #tab-itens .large-card').forEach(el => el.style.display = 'block');
            document.querySelector('#tab-itens .filters').style.display = 'flex';
            document.querySelector('#tab-itens .date-filter-container').style.display = 'flex';
        }

        function updateItensUI(data) {
            const periodBadge = document.getElementById('period-badge-itens');
            periodBadge.textContent = data.length > 0 ? "Itens Carregados" : "Sem Dados";

            // KPIs
            const totalValor = data.reduce((sum, r) => sum + (r.Valor || 0), 0);
            const totalQtd = data.reduce((sum, r) => sum + (r.Quantidade || 0), 0);
            const produtoCount = {};
            data.forEach(r => {
                produtoCount[r['Produto/Servi√ßo']] = (produtoCount[r['Produto/Servi√ßo']] || 0) + (r.Quantidade || 0);
            });
            const topProduto = Object.entries(produtoCount).sort((a,b) => b[1] - a[1])[0]?.[0] || '‚Äî';

            document.getElementById('kpi-total-itens').textContent = formatCurrency(totalValor);
            document.getElementById('kpi-qtd-itens').textContent = totalQtd.toLocaleString('pt-BR');
            document.getElementById('kpi-top-produto').textContent = topProduto;

            // Sidebar: Top Clientes
            const clienteValor = {};
            data.forEach(r => {
                clienteValor[r.Cliente] = (clienteValor[r.Cliente] || 0) + (r.Valor || 0);
            });
            const topClientes = Object.entries(clienteValor).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const listHTML = topClientes.map(([cliente, valor], i) => `
                <div class="vendor-item">
                    <div class="vendor-info">
                        <div class="vendor-rank">${i+1}</div>
                        <div class="vendor-name">${cliente}</div>
                    </div>
                    <div class="vendor-value">${formatCurrency(valor)}</div>
                </div>
            `).join('');
            document.getElementById('vendor-list-itens').innerHTML = listHTML || '<p style="color:var(--text-muted);text-align:center;">Nenhum cliente</p>';

            // Gr√°ficos
            renderProdutosChart(data);
            renderClientesItensChart(data);
        }

        function renderProdutosChart(data) {
            const prodValor = {};
            data.forEach(r => {
                prodValor[r['Produto/Servi√ßo']] = (prodValor[r['Produto/Servi√ßo']] || 0) + (r.Valor || 0);
            });
            const top10 = Object.entries(prodValor).sort((a,b) => b[1] - a[1]).slice(0, 10);
            Highcharts.chart('chart-produtos', {
                chart: { type: 'column' },
                title: { text: null },
                xAxis: { categories: top10.map(p => p[0]) },
                yAxis: { title: { enabled: false } },
                series: [{ name: 'Valor', data: top10.map(p => p[1]), color: '#f59e0b' }],
                tooltip: { formatter: function() { return `<b>${this.x}</b><br>Valor: ${formatCurrency(this.y)}`; } }
            });
        }

        function renderClientesItensChart(data) {
            const cliValor = {};
            data.forEach(r => {
                cliValor[r.Cliente] = (cliValor[r.Cliente] || 0) + (r.Valor || 0);
            });
            const top5 = Object.entries(cliValor).sort((a,b) => b[1] - a[1]).slice(0, 5);
            Highcharts.chart('chart-clientes-itens', {
                chart: { type: 'bar' },
                title: { text: null },
                xAxis: { categories: top5.map(c => c[0]) },
                yAxis: { title: { enabled: false } },
                series: [{ name: 'Valor', data: top5.map(c => c[1]), color: '#14b8a6' }],
                tooltip: { formatter: function() { return `<b>${this.x}</b><br>Valor: ${formatCurrency(this.y)}`; } }
            });
        }

        // --- UPLOAD DE ITENS ---
        function initializeAdminView(tab) {
            if (tab === 'vendas') {
                document.getElementById('login-area').classList.add('hidden');
                document.getElementById('upload-area').classList.remove('hidden');
                document.querySelector('#tab-vendas .header').style.display = 'block';
            } else {
                document.getElementById('login-area-itens').classList.add('hidden');
                document.getElementById('upload-area-itens').classList.remove('hidden');
                document.querySelector('#tab-itens .header').style.display = 'block';
            }
            if (tab === 'itens') setupUploadAreaItens();
            else setupUploadArea(); // j√° existe
        }

        function setupUploadAreaItens() {
            const uploadArea = document.getElementById('upload-area-itens');
            const fileInput = document.getElementById('csv-file-itens');
            document.getElementById('publish-btn-itens').addEventListener('click', () => publishDataToFirebase('itens'));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, p => { p.preventDefault(); p.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.add('active')));
            ['dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.remove('active')));
            uploadArea.addEventListener('drop', e => handleFilesItens(e.dataTransfer.files));
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => handleFilesItens(e.target.files));
        }

        function handleFilesItens(files) {
            if (files.length > 0) {
                Papa.parse(files[0], {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: ";",
                    encoding: "UTF-8",
                    complete: results => processDataForPublishingItens(results.data),
                    error: error => alert(`Erro no CSV: ${error.message}`)
                });
            }
        }

        function processDataForPublishingItens(data) {
            const statusMessage = document.getElementById('status-message-itens');
            try {
                const allRows = data.map(row => {
                    const valorStr = String(row.Valor || '0').replace('R$', '').trim().replace(/\./g, '').replace(',', '.');
                    const valor = parseFloat(valorStr);
                    const qtdStr = String(row.Quantidade || '0').replace(/\./g, '').replace(',', '.');
                    const qtd = parseFloat(qtdStr);
                    if (isNaN(valor) || isNaN(qtd) || !row.Cliente || !row['Produto/Servi√ßo']) return null;
                    return {
                        Cliente: row.Cliente.trim(),
                        'Produto/Servi√ßo': row['Produto/Servi√ßo'].trim(),
                        Quantidade: qtd,
                        '√öltimo pre√ßo': row['√öltimo pre√ßo']?.trim() || '',
                        Valor: valor
                    };
                }).filter(Boolean);
                processedDataForPublishItens = { allRows, timestamp: new Date().toISOString() };
                document.getElementById('publish-container-itens').style.display = 'block';
                document.getElementById('publish-btn-itens').disabled = false;
                statusMessage.textContent = `${allRows.length} registros prontos.`;
                statusMessage.className = 'status-message';
            } catch (error) {
                statusMessage.textContent = `Erro: ${error.message}`;
                statusMessage.className = 'status-message error';
            }
        }

        async function publishDataToFirebase(tab) {
            const data = tab === 'vendas' ? processedDataForPublishVendas : processedDataForPublishItens;
            if (!data) return;
            const btn = tab === 'vendas' ? document.getElementById('publish-btn') : document.getElementById('publish-btn-itens');
            const msg = tab === 'vendas' ? document.getElementById('status-message') : document.getElementById('status-message-itens');
            btn.disabled = true;
            btn.textContent = 'Publicando...';
            try {
                await db.collection('dashboard').doc(tab === 'vendas' ? 'dados' : 'itens').set(data);
                msg.textContent = 'Sucesso!';
                msg.className = 'status-message success';
            } catch (error) {
                msg.textContent = `Erro: ${error.message}`;
                msg.className = 'status-message error';
                btn.textContent = 'Tentar Novamente';
            } finally {
                btn.disabled = false;
                btn.textContent = tab === 'vendas' ? 'Publicar Dados' : 'Publicar Dados';
            }
        }

        // --- UTILS ---
        function formatCurrency(value) {
            return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function setupHighchartsTheme() {
            Highcharts.setOptions({
                chart: { backgroundColor: 'transparent', style: { fontFamily: 'Inter' } },
                title: { style: { color: 'var(--text-primary)' } },
                xAxis: { labels: { style: { color: 'var(--text-secondary)' } }, lineColor: 'var(--border-color)', tickColor: 'var(--border-color)' },
                yAxis: { title: { style: { color: 'var(--text-secondary)' } }, labels: { style: { color: 'var(--text-secondary)' } }, gridLineColor: 'var(--border-color)' },
                legend: { itemStyle: { color: 'var(--text-primary)' } },
                tooltip: { backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', style: { color: 'var(--text-primary)' } },
                credits: { enabled: false }
            });
        }

        // --- Fun√ß√µes de login, filtros, etc. para vendas mantidas como no original ---
        // (Voc√™ pode copiar as fun√ß√µes originais de login, filtros, etc., e adaptar com sufixo "-itens" se quiser filtros por data nos itens)
    </script>
</body>
</html>
