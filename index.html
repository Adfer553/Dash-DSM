<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSM Torre de Controle - Dashboard de Vendas</title>
    <style>
        /* [Estilos mantidos como no original, sem alteraÃ§Ãµes] */
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="dsm-logo">
                        <img src="data:image/png;base64,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" alt="Logo DSM">
                    </div>
                    <div class="header-info">
                        <h1>Torre de Controle - Vendas</h1>
                        <p>Odontologia do Futuro | Dental Medicine Solutions</p>
                    </div>
                </div>
                <div class="header-stats">
                    <div id="period-badge" class="period-badge">Sem Dados</div>
                    <div class="filters" style="display: none;">
                        <button class="filter-btn active" data-filter="all">Tudo</button>
                        <button class="filter-btn" data-filter="30">30d</button>
                        <button class="filter-btn" data-filter="7">7d</button>
                        <button class="filter-btn" data-filter="1">Hoje</button>
                    </div>
                    <div class="date-filter-container" style="display: none;">
                        <input type="date" id="start-date" class="date-input" title="Data inicial">
                        <span class="date-separator">atÃ©</span>
                        <input type="date" id="end-date" class="date-input" title="Data final">
                        <button class="apply-date-btn" id="apply-date-btn" title="Aplicar filtro de data">Aplicar</button>
                        <button class="clear-date-btn" id="clear-date-btn" title="Limpar filtro de data">Limpar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="login-area hidden" id="login-area">
            <div class="login-text">Acesso Administrador</div>
            <form class="login-form" id="login-form">
                <input type="email" id="login-email" class="login-input" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" class="login-input" placeholder="Sua senha" required>
                <button type="submit" class="login-btn">Entrar</button>
            </form>
            <div class="status-message" id="login-status-message"></div>
        </div>

        <div class="upload-area hidden" id="upload-area">
            <div class="upload-icon">ðŸ“Š</div>
            <div class="upload-text">Carregar RelatÃ³rio de Vendas</div>
            <div class="upload-subtext">Arraste seu arquivo CSV aqui ou <span class="upload-highlight">clique para selecionar</span></div>
            <input type="file" id="csv-file" accept=".csv" style="display:none;">
            <div class="publish-container" id="publish-container" style="display: none;">
                <button class="publish-btn" id="publish-btn" disabled>Publicar Dados</button>
                <div class="status-message" id="status-message"></div>
            </div>
        </div>
        
        <div class="card kpi-card" id="kpi-card-1" style="display: none;">
            <div class="card-header">
                <span class="card-title">Vendas Totais</span>
                <div class="card-icon" style="background: var(--gradient-teal);">ðŸ’°</div>
            </div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-total">R$ 0,00</div>
                <div class="kpi-subtitle">PerÃ­odo Selecionado</div>
            </div>
        </div>
        
        <div class="card kpi-card" id="kpi-card-2" style="display: none;">
            <div class="card-header">
                <span class="card-title">Ticket MÃ©dio</span>
                <div class="card-icon" style="background: var(--gradient-orange);">ðŸŽ«</div>
            </div>
            <div class="kpi-content">
                <div class="kpi-value orange" id="kpi-ticket">R$ 0,00</div>
                <div class="kpi-subtitle">Por TransaÃ§Ã£o</div>
            </div>
        </div>
        
        <div class="card kpi-card" id="kpi-card-3" style="display: none;">
            <div class="card-header">
                <span class="card-title">Total Vendas</span>
                <div class="card-icon" style="background: var(--gradient-blue);">ðŸ“ˆ</div>
            </div>
            <div class="kpi-content">
                <div class="kpi-value blue" id="kpi-count">0</div>
                <div class="kpi-subtitle">TransaÃ§Ãµes</div>
            </div>
        </div>
        
        <div class="card sidebar-card" id="sidebar-card" style="display: none;">
            <div class="card-header">
                <span class="card-title">Top Vendedores</span>
                <div class="card-icon" style="background: var(--gradient-dsm);">ðŸ‘‘</div>
            </div>
            <div class="vendor-list" id="vendor-list"></div>
            <div class="performance-ratio" id="performance-ratio"></div>
        </div>
        
        <div class="card large-card" id="chart-card-1" style="display: none;">
            <div class="card-header">
                <span class="card-title" id="chart-evolucao-title">EvoluÃ§Ã£o de Vendas</span>
                <div class="card-icon" style="background: var(--gradient-blue);">ðŸ“ˆ</div>
            </div>
            <div class="chart-container" id="chart-evolucao"></div>
        </div>
        
        <div class="card large-card" id="chart-card-2" style="display: none;">
            <div class="card-header">
                <span class="card-title">Top 10 Clientes</span>
                <div class="card-icon" style="background: var(--gradient-teal);">ðŸ‘¥</div>
            </div>
            <div class="chart-container" id="chart-clientes"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDl9TAAJxXCoyBjZa5xJVSx2-9ijq19iAs",
            authDomain: "dash-board-dsm.firebaseapp.com",
            projectId: "dash-board-dsm",
            storageBucket: "dash-board-dsm.appspot.com",
            messagingSenderId: "539970664229",
            appId: "1:539970664229:web:c84df6bcf621d85fab0ccc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let originalData = null;
        let processedDataForPublish = null;
        let customDateFilter = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';

            setupHighchartsTheme();

            if (isAdmin) {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        initializeAdminView();
                    } else {
                        initializeLoginView();
                    }
                });
            } else {
                fetchAndDisplayPublicDashboard();
            }
        });

        function initializeLoginView() {
            document.getElementById('login-area').classList.remove('hidden');
            document.getElementById('upload-area').classList.add('hidden');
            document.querySelector('.header').style.display = 'none';
            document.getElementById('login-form').addEventListener('submit', handleAdminLogin);
        }

        function initializeAdminView() {
            document.getElementById('login-area').classList.add('hidden');
            document.getElementById('upload-area').classList.remove('hidden');
            document.querySelector('.header').style.display = 'block';
            document.getElementById('period-badge').textContent = "Modo Admin";
            setupUploadArea();
        }

        async function fetchAndDisplayPublicDashboard() {
            const periodBadge = document.getElementById('period-badge');
            try {
                periodBadge.textContent = "Carregando Dados...";
                const doc = await db.collection('dashboard').doc('dados').get();

                if (doc.exists) {
                    const data = doc.data();
                    originalData = data.allRows.map(r => ({ ...r, Data: new Date(r.Data) }));
                    
                    document.querySelectorAll('.kpi-card, .sidebar-card, .large-card').forEach(el => el.style.display = 'block');
                    document.querySelector('.filters').style.display = 'flex';
                    document.querySelector('.date-filter-container').style.display = 'flex';

                    setupFilters();
                    setupDateFilter();
                    
                    document.querySelector('.filter-btn.active')?.classList.remove('active');
                    document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                    applyFilter('all');
                } else {
                    periodBadge.textContent = "Nenhum dado publicado";
                }
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
                periodBadge.textContent = "Erro ao Carregar";
            }
        }

        async function handleAdminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const statusMessage = document.getElementById('login-status-message');
            
            statusMessage.textContent = 'Autenticando...';
            statusMessage.className = 'status-message';

            try {
                await auth.signInWithEmailAndPassword(email, password);
                statusMessage.textContent = '';
            } catch (error) {
                statusMessage.textContent = `Erro: ${error.message}`;
                statusMessage.className = 'status-message error';
            }
        }

        function setupUploadArea() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('csv-file');
            document.getElementById('publish-btn').addEventListener('click', publishDataToFirebase);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, p => { p.preventDefault(); p.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.add('active')));
            ['dragleave', 'drop'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.remove('active')));
            uploadArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => handleFiles(e.target.files));
        }

        // --- CORREÃ‡ÃƒO DEFINITIVA DE ENCODING ---
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();

                reader.onload = function(event) {
                    const csvDataAsString = event.target.result;

                    // Testar diferentes delimitadores e codificaÃ§Ãµes
                    const parseOptions = [
                        { delimiter: ";", encoding: "UTF-8" },
                        { delimiter: ",", encoding: "UTF-8" },
                        { delimiter: ";", encoding: "ISO-8859-1" },
                        { delimiter: ",", encoding: "ISO-8859-1" }
                    ];

                    let parsedData = null;
                    for (const options of parseOptions) {
                        try {
                            const result = Papa.parse(csvDataAsString, {
                                header: true,
                                skipEmptyLines: true,
                                delimiter: options.delimiter,
                                encoding: options.encoding,
                                complete: (results) => results
                            });
                            if (result.data.length > 0 && result.data[0].hasOwnProperty('Vendedor')) {
                                parsedData = result.data;
                                console.log(`Parsing bem-sucedido com delimitador "${options.delimiter}" e encoding "${options.encoding}"`);
                                break;
                            }
                        } catch (e) {
                            console.warn(`Falha ao parsear com ${options.delimiter} e ${options.encoding}: ${e.message}`);
                        }
                    }

                    if (parsedData) {
                        processDataForPublishing(parsedData);
                    } else {
                        alert('NÃ£o foi possÃ­vel processar o arquivo CSV. Verifique o formato ou a codificaÃ§Ã£o.');
                    }
                };

                reader.onerror = function() {
                    alert('NÃ£o foi possÃ­vel ler o arquivo. Erro: ' + reader.error);
                };

                reader.readAsText(file);
            }
        }

        function processDataForPublishing(data) {
            const statusMessage = document.getElementById('status-message');
            try {
                const allRows = data.map(row => {
                    const valorStr = String(row.Valor || '0').replace('R$', '').trim().replace(/\./g, '').replace(',', '.');
                    const valor = parseFloat(valorStr);
                    if (isNaN(valor) || !row.Data || !row.Vendedor || !row.Cliente) return null;
                    const [day, month, year] = row.Data.split('/');
                    return {
                        Vendedor: row.Vendedor.trim(),
                        Cliente: row.Cliente.trim(),
                        Data: new Date(`${year}-${month}-${day}T00:00:00Z`).toISOString(),
                        Valor: valor
                    };
                }).filter(Boolean);

                processedDataForPublish = { allRows, timestamp: new Date().toISOString() };
                document.getElementById('publish-container').style.display = 'block';
                document.getElementById('publish-btn').disabled = false;
                statusMessage.textContent = `${allRows.length} registros prontos para publicar.`;
                statusMessage.className = 'status-message';

                // DepuraÃ§Ã£o para verificar codificaÃ§Ã£o
                console.log('Dados processados:', allRows);
            } catch (error) {
                statusMessage.textContent = `Erro ao processar arquivo: ${error.message}`;
                statusMessage.className = 'status-message error';
                console.error('Erro detalhado:', error);
            }
        }

        async function publishDataToFirebase() {
            if (!processedDataForPublish) return;
            const publishBtn = document.getElementById('publish-btn');
            const statusMessage = document.getElementById('status-message');
            
            publishBtn.disabled = true;
            publishBtn.textContent = 'Publicando...';
            statusMessage.className = 'status-message';
            statusMessage.textContent = 'Enviando dados...';

            try {
                await db.collection('dashboard').doc('dados').set(processedDataForPublish);
                statusMessage.textContent = 'Sucesso! Dados publicados.';
                statusMessage.className = 'status-message success';
                publishBtn.textContent = 'Publicar Novos Dados';
            } catch (error) {
                console.error("Erro ao publicar: ", error);
                statusMessage.textContent = `Erro ao publicar: ${error.message}`;
                statusMessage.className = 'status-message error';
                publishBtn.textContent = 'Tentar Publicar Novamente';
            } finally {
                publishBtn.disabled = false;
            }
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!originalData) return;
                    
                    customDateFilter = null;
                    document.getElementById('start-date').value = '';
                    document.getElementById('end-date').value = '';
                    
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilter(this.dataset.filter);
                });
            });
        }

        function setupDateFilter() {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const applyBtn = document.getElementById('apply-date-btn');
            const clearBtn = document.getElementById('clear-date-btn');

            applyBtn.addEventListener('click', function() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (!startDate || !endDate) {
                    alert('Por favor, selecione ambas as datas.');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('A data inicial deve ser anterior ou igual Ã  data final.');
                    return;
                }
                
                customDateFilter = {
                    start: new Date(startDate + 'T00:00:00Z'),
                    end: new Date(endDate + 'T23:59:59Z')
                };
                
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                
                applyCustomDateFilter();
            });

            clearBtn.addEventListener('click', function() {
                startDateInput.value = '';
                endDateInput.value = '';
                customDateFilter = null;
                
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                applyFilter('all');
            });
        }

        function applyFilter(days) {
            let filteredData;
            if (days === 'all') {
                filteredData = originalData;
            } else {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (days === '1') {
                    filteredData = originalData.filter(row => {
                        const rowDate = new Date(row.Data);
                        rowDate.setHours(0, 0, 0, 0);
                        return rowDate.getTime() === today.getTime();
                    });
                } else {
                    const cutoffDate = new Date(today);
                    cutoffDate.setDate(today.getDate() - parseInt(days) + 1);
                    filteredData = originalData.filter(row => row.Data >= cutoffDate);
                }
            }
            updateDashboardUI(filteredData);
        }

        function applyCustomDateFilter() {
            if (!customDateFilter || !originalData) return;
            
            const filteredData = originalData.filter(row => {
                const rowDate = new Date(row.Data);
                return rowDate >= customDateFilter.start && rowDate <= customDateFilter.end;
            });
            
            updateDashboardUI(filteredData);
        }

        function updateDashboardUI(data) {
            const periodBadge = document.getElementById('period-badge');
            if (data && data.length > 0) {
                const dates = data.map(r => r.Data);
                const firstDate = new Date(Math.min.apply(null, dates));
                const lastDate = new Date(Math.max.apply(null, dates));
                
                periodBadge.textContent = `${firstDate.toLocaleDateString('pt-BR')} - ${lastDate.toLocaleDateString('pt-BR')}`;
            } else {
                periodBadge.textContent = "Sem Dados no PerÃ­odo";
            }
            updateKPIs(data);
            updateSidebar(data);
            renderEvolucaoChart(data);
            renderClientesChart(data);
        }

        function formatCurrency(value) {
            return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function updateKPIs(data) {
            const totalVendas = data.reduce((sum, row) => sum + row.Valor, 0);
            const numVendas = data.length;
            const ticketMedio = numVendas > 0 ? totalVendas / numVendas : 0;
            document.getElementById('kpi-total').textContent = formatCurrency(totalVendas);
            document.getElementById('kpi-count').textContent = numVendas.toLocaleString('pt-BR');
            document.getElementById('kpi-ticket').textContent = formatCurrency(ticketMedio);
        }

        function updateSidebar(data) {
            const totalVendas = data.reduce((sum, row) => sum + row.Valor, 0);
            const salesByVendedor = data.reduce((acc, row) => {
                acc[row.Vendedor] = (acc[row.Vendedor] || 0) + row.Valor;
                return acc;
            }, {});
            const sortedVendedores = Object.entries(salesByVendedor).sort(([,a],[,b]) => b - a).slice(0, 5);
            const vendorList = document.getElementById('vendor-list');
            const ratioContainer = document.getElementById('performance-ratio');
            if (sortedVendedores.length === 0) {
                vendorList.innerHTML = `<p style="color: var(--text-muted); text-align: center;">Nenhum vendedor no perÃ­odo.</p>`;
                ratioContainer.innerHTML = '';
            } else {
                const vendorListHTML = sortedVendedores.map(([name, value], index) => {
                    return `
                        <div class="vendor-item">
                            <div class="vendor-info">
                                <div class="vendor-rank">${index + 1}</div>
                                <div class="vendor-name">${name}</div>
                            </div>
                            <div class="vendor-value">${formatCurrency(value)}</div>
                        </div>
                    `;
                }).join('');
                vendorList.innerHTML = vendorListHTML;
                const ratioHeaderHTML = `<h4 style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;">Performance Ratio (Top 5)</h4>`;
                const ratioItemsHTML = sortedVendedores.map(([name, value], index) => {
                    const percentage = totalVendas > 0 ? (value / totalVendas) * 100 : 0;
                    const color = index === 0 ? 'var(--accent-teal)' : 'var(--accent-blue)';
                    return `
                        <div class="ratio-item" style="margin-bottom: 8px;">
                            <span>${name.split(' ')[0]}</span>
                            <span style="font-weight: 600; color: ${color};">${percentage.toFixed(1)}%</span>
                        </div>
                    `;
                }).join('');
                ratioContainer.innerHTML = ratioHeaderHTML + ratioItemsHTML;
            }
        }

        function renderEvolucaoChart(data) {
            const salesByDate = data.reduce((acc, row) => {
                const dateString = row.Data.toISOString().split('T')[0];
                acc[dateString] = (acc[dateString] || 0) + row.Valor; 
                return acc;
            }, {});
            const sortedDates = Object.entries(salesByDate).sort((a,b) => new Date(a[0]) - new Date(b[0]));
            
            Highcharts.chart('chart-evolucao', { 
                chart: { type: 'areaspline' }, 
                title: { text: null }, 
                xAxis: { 
                    categories: sortedDates.map(d => new Date(d[0]+"T00:00:00Z").toLocaleDateString('pt-BR', {
                        timeZone: 'UTC', 
                        day: '2-digit', 
                        month: 'short'
                    }))
                }, 
                yAxis: { 
                    title: { text: null },
                    labels: {
                        formatter: function() {
                            return 'R$ ' + (this.value / 1000).toFixed(0) + 'k';
                        }
                    }
                }, 
                legend: { enabled: false }, 
                plotOptions: { 
                    areaspline: { 
                        fillColor: { 
                            linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, 
                            stops: [ 
                                [0, 'rgba(20, 184, 166, 0.8)'], 
                                [1, 'rgba(20, 184, 166, 0.1)'] 
                            ] 
                        }, 
                        lineColor: '#14b8a6', 
                        lineWidth: 3, 
                        marker: { 
                            fillColor: '#14b8a6', 
                            lineColor: '#ffffff', 
                            lineWidth: 2, 
                            radius: 5
                        } 
                    } 
                }, 
                series: [{ 
                    name: 'Vendas', 
                    data: sortedDates.map(d => d[1]) 
                }], 
                tooltip: { 
                    formatter: function() { 
                        return `<b>${this.x}</b><br>Vendas: ${formatCurrency(this.y)}`; 
                    } 
                }
            });
        }

        function renderClientesChart(data) {
            const salesByCliente = data.reduce((acc, row) => {
                acc[row.Cliente] = (acc[row.Cliente] || 0) + row.Valor; 
                return acc;
            }, {});
            const sortedClientes = Object.entries(salesByCliente).sort(([,a],[,b]) => b-a).slice(0, 10);
            
            Highcharts.chart('chart-clientes', { 
                chart: { type: 'bar' }, 
                title: { text: null }, 
                xAxis: { 
                    categories: sortedClientes.map(c => c[0]), 
                    labels: { 
                        style: { 
                            whiteSpace: 'nowrap', 
                            overflow: 'hidden', 
                            textOverflow: 'ellipsis'
                        } 
                    } 
                }, 
                yAxis: { 
                    title: { enabled: false },
                    labels: {
                        formatter: function() {
                            return 'R$ ' + (this.value / 1000).toFixed(0) + 'k';
                        }
                    }
                }, 
                legend: { enabled: false }, 
                series: [{ 
                    name: 'Total Comprado', 
                    data: sortedClientes.map(c => c[1]), 
                    color: 'var(--accent-blue)'
                }], 
                tooltip: { 
                    formatter: function() { 
                        return `<b>${this.x}</b><br>Total: ${formatCurrency(this.y)}`; 
                    } 
                }
            });
        }
        
        function setupHighchartsTheme() {
            Highcharts.setOptions({ 
                chart: { backgroundColor: 'transparent', style: { fontFamily: 'Inter' } }, 
                title: { style: { color: 'var(--text-primary)' } }, 
                xAxis: { labels: { style: { color: 'var(--text-secondary)' } }, lineColor: 'var(--border-color)', tickColor: 'var(--border-color)' }, 
                yAxis: { title: { style: { color: 'var(--text-secondary)' } }, labels: { style: { color: 'var(--text-secondary)' } }, gridLineColor: 'var(--border-color)' }, 
                legend: { itemStyle: { color: 'var(--text-primary)' } }, 
                tooltip: { backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', style: { color: 'var(--text-primary)' } }, 
                credits: { enabled: false } 
            });
        }
    </script>
</body>
</html>
