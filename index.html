<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSM Torre de Controle - Dashboard de Vendas</title>
    <style>
        /* --- SEU CSS ORIGINAL --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        :root { 
            --dsm-blue: #1f4788; --dsm-green: #4caf50; --bg-primary: #0f1419; --bg-secondary: #1a202c; --bg-card: #2d3748; --bg-card-hover: #374151; --border-color: #4a5568; --text-primary: #ffffff; --text-secondary: #cbd5e0; --text-muted: #a0aec0; --accent-blue: #3b82f6; --accent-teal: #14b8a6; --accent-orange: #f59e0b; --accent-green: #10b981; --accent-red: #ef4444; --gradient-dsm: linear-gradient(135deg, var(--dsm-blue) 0%, var(--dsm-green) 100%);
        }
        body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .dashboard { padding: 24px; max-width: 1920px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr 1fr 1fr; grid-template-areas: "header header header header" "sidebar kpi1 kpi2 kpi3" "sidebar chart1 chart1 chart2"; gap: 24px; }
        .header { grid-area: header; background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border-color); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 24px; }
        .dsm-logo img { height: 45px; width: auto; }
        .header-info h1 { font-size: 28px; font-weight: 700; }
        .upload-area, .login-area { grid-column: 1 / -1; padding: 48px; border: 3px dashed var(--border-color); border-radius: 16px; text-align: center; margin-top: 16px; }
        .hidden { display: none; }
        .publish-btn { background: var(--gradient-dsm); color: white; font-weight: bold; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; }
        .status-message { margin-top: 12px; font-size: 14px; }
        .status-message.success { color: var(--accent-green); }
        .status-message.error { color: var(--accent-red); }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="dsm-logo">
                        <img src="https://via.placeholder.com/150x45?text=Logo" alt="Logo DSM">
                    </div>
                    <div class="header-info">
                        <h1>DSM - Dash Comercial</h1>
                    </div>
                </div>
                <div id="period-badge" class="period-badge">Sem Dados</div>
            </div>
        </div>

        <!-- LOGIN -->
        <div class="login-area hidden" id="login-area">
            <div class="login-text">Acesso Administrador</div>
            <form class="login-form" id="login-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit" class="publish-btn">Entrar</button>
            </form>
            <div class="status-message" id="login-status-message"></div>
        </div>

        <!-- UPLOAD CSV -->
        <div class="upload-area hidden" id="upload-area">
            <div class="upload-icon">üìä</div>
            <div class="upload-text">Carregar Relat√≥rio de Vendas</div>
            <input type="file" id="csv-file" accept=".csv" style="display:none;">
            <div class="publish-container" id="publish-container" style="display: none;">
                <button class="publish-btn" id="publish-btn" disabled>Publicar Dados</button>
                <div class="status-message" id="status-message"></div>
            </div>
        </div>

        <!-- üîπ NOVO BLOCO: UPLOAD LOGO -->
        <div class="upload-area hidden" id="logo-upload-area">
            <div class="upload-icon">üè¢</div>
            <div class="upload-text">Carregar Logo da Empresa</div>
            <input type="file" id="logo-file" accept="image/*" style="display:none;">
            <div class="publish-container">
                <button class="publish-btn" id="publish-logo-btn" disabled>Publicar Logo</button>
                <div class="status-message" id="logo-status-message"></div>
            </div>
        </div>
    </div>

    <!-- DEPEND√äNCIAS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "SUA-APIKEY",
            authDomain: "dash-board-dsm.firebaseapp.com",
            projectId: "dash-board-dsm",
            storageBucket: "dash-board-dsm.appspot.com",
            messagingSenderId: "539970664229",
            appId: "1:539970664229:web:c84df6bcf621d85fab0ccc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get("admin") === "true";

            if (isAdmin) {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        initializeAdminView();
                    } else {
                        initializeLoginView();
                    }
                });
            } else {
                fetchAndDisplayPublicDashboard();
            }
        });

        // LOGIN
        function initializeLoginView() {
            document.getElementById("login-area").classList.remove("hidden");
            document.getElementById("login-form").addEventListener("submit", handleAdminLogin);
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                document.getElementById("login-status-message").textContent = error.message;
            }
        }

        // ADMIN VIEW
        function initializeAdminView() {
            document.getElementById("login-area").classList.add("hidden");
            document.getElementById("upload-area").classList.remove("hidden");
            document.getElementById("logo-upload-area").classList.remove("hidden");
            setupLogoUpload();
        }

        // UPLOAD LOGO
        function setupLogoUpload() {
            const logoFileInput = document.getElementById("logo-file");
            const publishLogoBtn = document.getElementById("publish-logo-btn");
            const logoStatusMessage = document.getElementById("logo-status-message");

            document.getElementById("logo-upload-area").addEventListener("click", () => logoFileInput.click());

            logoFileInput.addEventListener("change", e => {
                const file = e.target.files[0];
                if (!file) return;
                publishLogoBtn.disabled = false;

                publishLogoBtn.onclick = async () => {
                    try {
                        logoStatusMessage.textContent = "‚è≥ Enviando logo...";
                        const storageRef = storage.ref("logos/" + file.name);
                        await storageRef.put(file);
                        const url = await storageRef.getDownloadURL();
                        await db.collection("dashboard").doc("config").set({ logoUrl: url }, { merge: true });
                        logoStatusMessage.textContent = "‚úÖ Logo publicada!";
                        logoStatusMessage.className = "status-message success";
                    } catch (err) {
                        logoStatusMessage.textContent = "Erro: " + err.message;
                        logoStatusMessage.className = "status-message error";
                    }
                };
            });
        }

        // P√öBLICO: CARREGA LOGO
        async function fetchAndDisplayPublicDashboard() {
            try {
                const configDoc = await db.collection("dashboard").doc("config").get();
                if (configDoc.exists && configDoc.data().logoUrl) {
                    document.querySelector(".dsm-logo img").src = configDoc.data().logoUrl;
                }
            } catch (err) {
                console.error("Erro ao carregar logo:", err);
            }
        }
    </script>
</body>
</html>
